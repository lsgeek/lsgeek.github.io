<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Hi996</title>
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://blog.hi996.com/"/>
  <updated>2017-04-06T09:52:44.000Z</updated>
  <id>http://blog.hi996.com/</id>
  
  <author>
    <name>Liuonion</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>iOSå¤§è§£å¯†ä¹‹Weakå¼•ç”¨</title>
    <link href="http://blog.hi996.com/2017/04/06/iosweaks/"/>
    <id>http://blog.hi996.com/2017/04/06/iosweaks/</id>
    <published>2017-04-06T09:23:32.000Z</published>
    <updated>2017-04-06T09:52:44.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>assignä¸weakæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿé¢è¯•çš„æ—¶å€™å¸¸å¸¸ä¼šè¢«é—®åˆ°æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå›ç­”weakä¿®é¥°åœ¨å¯¹è±¡é‡Šæ”¾æ—¶ä¼šè‡ªåŠ¨å˜ä¸ºnil,é‚£ä¹ˆåº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿä»Šå¤©è®©æˆ‘ä»¬æ¥æ¢è®¨ä¸€ä¸‹ï¼Œæœ¬æ–‡ä½¿ç”¨çš„runtimeæºç ä¸ºå¤§ç¥æä¾›çš„å¯ç¼–è¯‘ç‰ˆæœ¬<a href="https://github.com/isaacselement/objc4-706" target="_blank" rel="external">objc4-706</a></p>
<h2 id="storeWeakâ€¦"><a href="#storeWeakâ€¦" class="headerlink" title="storeWeakâ€¦"></a>storeWeakâ€¦</h2><p>ä¸weakç›¸å…³çš„æ“ä½œï¼Œåº”è¯¥éƒ½è°ƒç”¨äº†æ¬¡æ–¹æ³•ï¼Œç¨åçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼Œé¦–å…ˆåšä¸€ä¸‹å‡†å¤‡å·¥ä½œ</p>
<p>æˆ‘é¦–å…ˆåœ¨é¡¹ç›®ä¸­å®šä¹‰äº†ä¸¤ä¸ªç±»Personã€Likeå®ç°å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@interface Person : NSObject</div><div class="line">@property (atomic,weak) Like *like;</div><div class="line">- (<span class="keyword">void</span>)logLikeAddress;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation Person</div><div class="line">- (<span class="keyword">void</span>)logLikeAddress</div><div class="line">&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%p"</span>,&amp;_like);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"><span class="comment">// Likeå…¶å®ä»€ä¹ˆä¹Ÿæ²¡å®ç°ğŸ˜‚</span></div><div class="line">@interface Like : NSObject</div><div class="line">@end</div><div class="line">@implementation Like</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>å…¶ä¸­mainå‡½æ•°ä¸º</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addLike</span><span class="params">(Person* person)</span></span></div><div class="line">&#123;</div><div class="line">    Like *like = [[Like alloc] init];</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"%p\n"</span>,like);</div><div class="line">    [person logLikeAddress];</div><div class="line">    person.like = like;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> * argv[])</span></span></div><div class="line">&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        <span class="comment">// insert code here...</span></div><div class="line">        Person *person = [[Person alloc] init];</div><div class="line">        addLike(person);</div><div class="line"></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å‡†å¤‡å·¥ä½œå·²ç»å°±ç»ªäº†ï¼Œæˆ‘ä»¬åœ¨<code>Person</code>çš„ä¸­<code>weak</code>ä¿®é¥°çš„å±æ€§ä¸‹æ–­ç‚¹ï¼Œå¹¶å•æ­¥è°ƒè¯•ï¼Œä¼šå‘ç°å¦‚ä¸‹çš„å‡½æ•°è°ƒç”¨æ ˆ</p>
<p><img src="http://omhkfini5.bkt.clouddn.com/b2.png" alt=""></p>
<p>æˆ‘ä»¬å‘ç°äº†å…³é”®çš„å‡½æ•°<code>objc_storeWeak(...)</code>,ä¸‹é¢æˆ‘ä»¬è¦è¯¦ç»†çš„æ¢è®¨è¿™ä¸€å‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span> &lt;<span class="keyword">bool</span> HaveOld, <span class="keyword">bool</span> HaveNew, <span class="keyword">bool</span> CrashIfDeallocating&gt;</div><div class="line"><span class="function"><span class="keyword">static</span> id </span></div><div class="line"><span class="title">storeWeak</span><span class="params">(id *location, objc_object *newObj)</span></div><div class="line">&#123;</div><div class="line">    assert(HaveOld  ||  HaveNew);</div><div class="line">    <span class="keyword">if</span> (!HaveNew) assert(newObj == nil);</div><div class="line"></div><div class="line">    Class previouslyInitializedClass = nil;</div><div class="line">    id oldObj;</div><div class="line">    <span class="comment">// æ–°æ—§å¼•ç”¨è¡¨åˆ›å»º</span></div><div class="line">    SideTable *oldTable;</div><div class="line">    SideTable *newTable;</div><div class="line"></div><div class="line">    <span class="comment">// Acquire locks for old and new values.</span></div><div class="line">    <span class="comment">// Order by lock address to prevent lock ordering problems. </span></div><div class="line">    <span class="comment">// Retry if the old value changes underneath us.</span></div><div class="line"> retry:</div><div class="line">    <span class="keyword">if</span> (HaveOld) &#123;</div><div class="line">        <span class="comment">// è·å–æ—§å¼•ç”¨è¡¨</span></div><div class="line">        oldObj = *location;</div><div class="line">        oldTable = &amp;SideTables()[oldObj];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        oldTable = nil;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (HaveNew) &#123;</div><div class="line">        <span class="comment">// è·å–æ–°å¼•ç”¨è¡¨</span></div><div class="line">        newTable = &amp;SideTables()[newObj];</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        newTable = nil;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// åŠ é”</span></div><div class="line">    SideTable::lockTwo&lt;HaveOld, HaveNew&gt;(oldTable, newTable);</div><div class="line">    <span class="comment">// location åº”è¯¥ä¸ oldObj ä¿æŒä¸€è‡´ï¼Œå¦åˆ™é‡æ–°è·å–</span></div><div class="line">    <span class="keyword">if</span> (HaveOld  &amp;&amp;  *location != oldObj) &#123;</div><div class="line">        SideTable::unlockTwo&lt;HaveOld, HaveNew&gt;(oldTable, newTable);</div><div class="line">        <span class="keyword">goto</span> retry;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Prevent a deadlock between the weak reference machinery</span></div><div class="line">    <span class="comment">// and the +initialize machinery by ensuring that no </span></div><div class="line">    <span class="comment">// weakly-referenced object has an un-+initialized isa.</span></div><div class="line">    <span class="keyword">if</span> (HaveNew  &amp;&amp;  newObj) &#123;</div><div class="line">        Class cls = newObj-&gt;getIsa();</div><div class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass  &amp;&amp;  </div><div class="line">            !((objc_class *)cls)-&gt;isInitialized()) </div><div class="line">        &#123;</div><div class="line">            SideTable::unlockTwo&lt;HaveOld, HaveNew&gt;(oldTable, newTable);</div><div class="line">            _class_initialize(_class_getNonMetaClass(cls, (id)newObj));</div><div class="line"></div><div class="line">            <span class="comment">// If this class is finished with +initialize then we're good.</span></div><div class="line">            <span class="comment">// If this class is still running +initialize on this thread </span></div><div class="line">            <span class="comment">// (i.e. +initialize called storeWeak on an instance of itself)</span></div><div class="line">            <span class="comment">// then we may proceed but it will appear initializing and </span></div><div class="line">            <span class="comment">// not yet initialized to the check above.</span></div><div class="line">            <span class="comment">// Instead set previouslyInitializedClass to recognize it on retry.</span></div><div class="line">            previouslyInitializedClass = cls;</div><div class="line"></div><div class="line">            <span class="keyword">goto</span> retry;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Clean up old value, if any. æ¸…é™¤æ—§å€¼</span></div><div class="line">    <span class="keyword">if</span> (HaveOld) &#123;</div><div class="line">        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Assign new value, if any. è®¾ç½®æ–°å€¼</span></div><div class="line">    <span class="keyword">if</span> (HaveNew) &#123;</div><div class="line">        newObj = (objc_object *)weak_register_no_lock(&amp;newTable-&gt;weak_table, </div><div class="line">                                                      (id)newObj, location, </div><div class="line">                                                      CrashIfDeallocating);</div><div class="line">        <span class="comment">// weak_register_no_lock returns nil if weak store should be rejected</span></div><div class="line"></div><div class="line">        <span class="comment">// Set is-weakly-referenced bit in refcount table.</span></div><div class="line">        <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</div><div class="line">            <span class="comment">// æ ‡è®°è¯¥å¯¹è±¡æ˜¯ä¸€ä¸ªå¼±å¼•ç”¨</span></div><div class="line">            newObj-&gt;setWeaklyReferenced_nolock();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// Do not set *location anywhere else. That would introduce a race.</span></div><div class="line">        *location = (id)newObj;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// No new value. The storage is not changed.</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    SideTable::unlockTwo&lt;HaveOld, HaveNew&gt;(oldTable, newTable);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (id)newObj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹è§ä¸€äº›å…³é”®ç‚¹ï¼Œ <code>SideTable</code>ï¼Œ <code>weak_unregister_no_lock(...)</code>ï¼Œ <code>weak_register_no_lockï¼ˆ...ï¼‰</code>ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šé€ä¸€ä»‹ç»</p>
<h2 id="å¼•ç”¨è®¡æ•°å’Œå¼±å¼•ç”¨ä¾èµ–è¡¨-SideTable"><a href="#å¼•ç”¨è®¡æ•°å’Œå¼±å¼•ç”¨ä¾èµ–è¡¨-SideTable" class="headerlink" title="å¼•ç”¨è®¡æ•°å’Œå¼±å¼•ç”¨ä¾èµ–è¡¨ SideTable"></a>å¼•ç”¨è®¡æ•°å’Œå¼±å¼•ç”¨ä¾èµ–è¡¨ SideTable</h2><p>SideTable æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œä¸»è¦ç”¨äºç®¡ç†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å’Œ weak è¡¨ã€‚åœ¨ NSObject.mm ä¸­å£°æ˜å…¶æ•°æ®ç»“æ„</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> SideTable &#123;</div><div class="line">    <span class="comment">//è‡ªæ—‹é”</span></div><div class="line">    <span class="keyword">spinlock_t</span> slock;</div><div class="line">    <span class="comment">// å¼•ç”¨è®¡æ•°è¡¨</span></div><div class="line">    RefcountMap refcnts;</div><div class="line">    <span class="comment">// å¼±å¼•ç”¨è¡¨</span></div><div class="line">    <span class="keyword">weak_table_t</span> weak_table;</div><div class="line"></div><div class="line">    SideTable() &#123;</div><div class="line">        <span class="built_in">memset</span>(&amp;weak_table, <span class="number">0</span>, <span class="keyword">sizeof</span>(weak_table));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ~SideTable() &#123;</div><div class="line">        _objc_fatal(<span class="string">"Do not delete SideTable."</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123; slock.lock(); &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">unlock</span><span class="params">()</span> </span>&#123; slock.unlock(); &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Address-ordered lock discipline for a pair of side tables.</span></div><div class="line"></div><div class="line">    <span class="keyword">template</span>&lt;<span class="keyword">bool</span> HaveOld, <span class="keyword">bool</span> HaveNew&gt;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">lockTwo</span><span class="params">(SideTable *lock1, SideTable *lock2)</span></span>;</div><div class="line">    <span class="keyword">template</span>&lt;<span class="keyword">bool</span> HaveOld, <span class="keyword">bool</span> HaveNew&gt;</div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unlockTwo</span><span class="params">(SideTable *lock1, SideTable *lock2)</span></span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å¯¹äºè¯¥ç»“æ„ä½“ä¸­çš„<code>slock</code>,<code>refcnts</code>,æš‚æ—¶æˆ‘ä»¬ä¸åšè®¨è®ºï¼Œæˆ‘ä»¬ä¸»è¦è®¨è®ºä¸å¼±å¼•ç”¨ç›¸å…³çš„<code>weak_table</code>ä½œç”¨ï¼Œå…¶ä¸­<code>weak_table_t</code>çš„ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> <span class="keyword">weak_table_t</span> &#123;</div><div class="line">    <span class="comment">// ä¿å­˜äº†æ‰€æœ‰æŒ‡å‘æŒ‡å®šå¯¹è±¡çš„ weak æŒ‡é’ˆ</span></div><div class="line">    <span class="keyword">weak_entry_t</span> *weak_entries;</div><div class="line">    <span class="comment">// å­˜å‚¨ç©ºé—´</span></div><div class="line">    <span class="keyword">size_t</span>    num_entries;</div><div class="line">    <span class="comment">// å‚ä¸åˆ¤æ–­å¼•ç”¨è®¡æ•°è¾…åŠ©é‡</span></div><div class="line">    <span class="keyword">uintptr_t</span> mask;</div><div class="line">    <span class="comment">// hash key æœ€å¤§åç§»å€¼</span></div><div class="line">    <span class="keyword">uintptr_t</span> max_hash_displacement;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªå…¨å±€å¼±å¼•ç”¨è¡¨ã€‚ä½¿ç”¨ä¸å®šç±»å‹å¯¹è±¡çš„åœ°å€ä½œä¸º key ï¼Œç”¨<code>weak_entry_t</code>ç±»å‹ç»“æ„ä½“å¯¹è±¡ä½œä¸ºvalueã€‚å…¶ä¸­çš„<code>weak_entries</code>æˆå‘˜ï¼Œä»å­—é¢æ„æ€ä¸Šçœ‹ï¼Œå³ä¸ºå¼±å¼•ç”¨è¡¨å…¥å£ã€‚å…¶å®ç°ä¹Ÿæ˜¯è¿™æ ·çš„</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">define</span> WEAK_INLINE_COUNT 4</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> REFERRERS_OUT_OF_LINE 2</span></div><div class="line"><span class="keyword">struct</span> <span class="keyword">weak_entry_t</span> &#123;</div><div class="line">    DisguisedPtr&lt;objc_object&gt; referent;</div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            <span class="keyword">weak_referrer_t</span> *referrers;</div><div class="line">            <span class="keyword">uintptr_t</span>        out_of_line_ness : <span class="number">2</span>;</div><div class="line">            <span class="keyword">uintptr_t</span>        num_refs : PTR_MINUS_2;</div><div class="line">            <span class="keyword">uintptr_t</span>        mask;</div><div class="line">            <span class="keyword">uintptr_t</span>        max_hash_displacement;</div><div class="line">        &#125;;</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            <span class="comment">// out_of_line_ness field is low bits of inline_referrers[1]</span></div><div class="line">            <span class="keyword">weak_referrer_t</span>  inline_referrers[WEAK_INLINE_COUNT];</div><div class="line">        &#125;;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">out_of_line</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (out_of_line_ness == REFERRERS_OUT_OF_LINE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">weak_entry_t</span>&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> <span class="keyword">weak_entry_t</span>&amp; other) &#123;</div><div class="line">        <span class="built_in">memcpy</span>(<span class="keyword">this</span>, &amp;other, <span class="keyword">sizeof</span>(other));</div><div class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">weak_entry_t</span>(objc_object *newReferent, objc_object **newReferrer)</div><div class="line">        : referent(newReferent)</div><div class="line">    &#123;</div><div class="line">        inline_referrers[<span class="number">0</span>] = newReferrer;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</div><div class="line">            inline_referrers[i] = nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>è®©æˆ‘ä»¬å›åˆ°<code>storeWeak(...)</code>å‡½æ•°ä¸­ï¼Œè·å–<code>oldTable</code>,ä¸<code>newTable</code>,å‘ç°è°ƒç”¨çš„å‡½æ•°ä¸º<code>&amp;SideTables()[newObj]</code>,<code>&amp;SideTables()[oldObj]</code>,å…¶ä¸­è¯¥æ–¹æ³•çš„å®ç°ä¸º</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">alignas(StripedMap&lt;SideTable&gt;) <span class="keyword">static</span> <span class="keyword">uint8_t</span> SideTableBuf[<span class="keyword">sizeof</span>(StripedMap&lt;SideTable&gt;)];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SideTableInit</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">new</span> (SideTableBuf) StripedMap&lt;SideTable&gt;();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">static</span> StripedMap&lt;SideTable&gt;&amp; SideTables() &#123;</div><div class="line">    <span class="keyword">return</span> *<span class="keyword">reinterpret_cast</span>&lt;StripedMap&lt;SideTable&gt;*&gt;(SideTableBuf);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="keyword">class</span> StripedMap &#123;</div><div class="line"></div><div class="line">    <span class="keyword">enum</span> &#123; CacheLineSize = <span class="number">64</span> &#125;;</div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_OS_EMBEDDED</span></div><div class="line">    <span class="keyword">enum</span> &#123; StripeCount = <span class="number">8</span> &#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">else</span></span></div><div class="line">    <span class="keyword">enum</span> &#123; StripeCount = <span class="number">64</span> &#125;;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line">    <span class="keyword">struct</span> PaddedT &#123;</div><div class="line">        <span class="function">T value <span class="title">alignas</span><span class="params">(CacheLineSize)</span></span>;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    PaddedT <span class="built_in">array</span>[StripeCount];</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">indexForPointer</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *p)</span> </span>&#123;</div><div class="line">        <span class="keyword">uintptr_t</span> addr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(p);</div><div class="line">        <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"> <span class="keyword">public</span>:</div><div class="line">    T&amp; <span class="keyword">operator</span>[] (<span class="keyword">const</span> <span class="keyword">void</span> *p) &#123; </div><div class="line">        <span class="keyword">return</span> <span class="built_in">array</span>[indexForPointer(p)].value; </div><div class="line">    &#125;</div><div class="line">    <span class="keyword">const</span> T&amp; <span class="keyword">operator</span>[] (<span class="keyword">const</span> <span class="keyword">void</span> *p) <span class="keyword">const</span> &#123; </div><div class="line">        <span class="keyword">return</span> <span class="keyword">const_cast</span>&lt;StripedMap&lt;T&gt;&gt;(<span class="keyword">this</span>)[p]; </div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>åœ¨ä¸Šé¢æˆ‘ä»¬å¯ä»¥çœ‹å‡º<code>StripedMap</code>æ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼ˆTemplate Classï¼‰ï¼Œé€šè¿‡ä¼ å…¥ç±»ï¼ˆç»“æ„ä½“ï¼‰å‚æ•°ï¼Œä¼šåŠ¨æ€ä¿®æ”¹åœ¨è¯¥ç±»ä¸­çš„ä¸€ä¸ª array æˆå‘˜å­˜å‚¨çš„å…ƒç´ ç±»å‹ï¼Œå¹¶ä¸”å…¶ä¸­æä¾›äº†ä¸€ä¸ªé’ˆå¯¹äºåœ°å€çš„ hash ç®—æ³•ï¼Œç”¨ä½œå­˜å‚¨keyã€‚å¯ä»¥è¯´ï¼Œ <code>StripedMap</code> æä¾›äº†ä¸€å¥—æ‹¥æœ‰å°†åœ°å€ä½œä¸º key çš„ hash table è§£å†³æ–¹æ¡ˆï¼Œè€Œè¯¥æ–¹æ¡ˆé‡‡ç”¨äº†æ¨¡æ¿ç±»ï¼Œæ˜¯æ‹¥æœ‰æ³›å‹æ€§çš„,åœ¨è¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ª array æˆå‘˜ï¼Œç”¨æ¥å­˜å‚¨ <code>PaddedT</code> å¯¹è±¡ï¼Œå¹¶ä¸”å…¶ä¸­å¯¹äº [] ç¬¦çš„é‡è½½å®šä¹‰ä¸­ï¼Œä¼šè¿”å›è¿™ä¸ª PaddedT çš„ value æˆå‘˜ï¼Œè¿™ä¸ª value å°±æ˜¯æˆ‘ä»¬ä¼ å…¥çš„ T æ³›å‹æˆå‘˜ï¼Œä¹Ÿå°±æ˜¯ <code>SideTable</code> å¯¹è±¡ã€‚åœ¨ array çš„ä¸‹æ ‡ä¸­ï¼Œè¿™é‡Œä½¿ç”¨äº† <code>indexForPointer</code> æ–¹æ³•é€šè¿‡ä½è¿ç®—è®¡ç®—ä¸‹æ ‡ï¼Œå®ç°äº†é™æ€çš„ Hash Tableã€‚è€Œåœ¨ <code>weak_table</code> ä¸­ï¼Œå…¶æˆå‘˜ <code>weak_entry</code>ä¼šå°†ä¼ å…¥å¯¹è±¡çš„åœ°å€åŠ ä»¥å°è£…èµ·æ¥ï¼Œå¹¶ä¸”å…¶ä¸­ä¹Ÿæœ‰è®¿é—®å…¨å±€å¼±å¼•ç”¨è¡¨çš„å…¥å£</p>
<h2 id="weak-register-no-lock-â€¦"><a href="#weak-register-no-lock-â€¦" class="headerlink" title="weak_register_no_lock(â€¦)"></a>weak_register_no_lock(â€¦)</h2><p>è¯¥æ–¹æ³•å°†å¼±å¼•ç”¨å¯¹è±¡æ³¨å†Œåˆ°å¼±å¼•ç”¨è¡¨ä¸­ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å®ƒçš„å…·ä½“å®ç°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="function">id </span></div><div class="line"><span class="title">weak_register_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id, </span></div><div class="line">                      id *referrer_id, <span class="keyword">bool</span> crashIfDeallocating)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// weakå¯¹è±¡çš„å¼•ç”¨ å³like</span></div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line">    <span class="comment">// æŒ‡å‘weakå¯¹è±¡çš„å¼•ç”¨çš„æŒ‡é’ˆ å³Personå¯¹è±¡ä¸­çš„&amp;like å¯ç†è§£ä¸º&amp;(person.like)</span></div><div class="line">    objc_object **referrer = (objc_object **)referrer_id;</div><div class="line"></div><div class="line">    <span class="comment">//åˆ¤æ–­TaggedPointer</span></div><div class="line">    <span class="keyword">if</span> (!referent  ||  referent-&gt;isTaggedPointer()) <span class="keyword">return</span> referent_id;</div><div class="line"></div><div class="line">    <span class="comment">// ensure that the referenced object is viable ä¿è¯å¯¹è±¡æ˜¯å¯ä»¥è®¿é—®çš„</span></div><div class="line">    <span class="keyword">bool</span> deallocating;</div><div class="line">    <span class="keyword">if</span> (!referent-&gt;ISA()-&gt;hasCustomRR()) &#123;</div><div class="line">        deallocating = referent-&gt;rootIsDeallocating();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        BOOL (*allowsWeakReference)(objc_object *, SEL) = </div><div class="line">            (BOOL(*)(objc_object *, SEL))</div><div class="line">            object_getMethodImplementation((id)referent, </div><div class="line">                                           SEL_allowsWeakReference);</div><div class="line">        <span class="keyword">if</span> ((IMP)allowsWeakReference == _objc_msgForward) &#123;</div><div class="line">            <span class="keyword">return</span> nil;</div><div class="line">        &#125;</div><div class="line">        deallocating =</div><div class="line">            ! (*allowsWeakReference)(referent, SEL_allowsWeakReference);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (deallocating) &#123;</div><div class="line">        <span class="keyword">if</span> (crashIfDeallocating) &#123;</div><div class="line">            _objc_fatal(<span class="string">"Cannot form weak reference to instance (%p) of "</span></div><div class="line">                        <span class="string">"class %s. It is possible that this object was "</span></div><div class="line">                        <span class="string">"over-released, or is in the process of deallocation."</span>,</div><div class="line">                        (<span class="keyword">void</span>*)referent, object_getClassName((id)referent));</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// now remember it and where it is being stored</span></div><div class="line">    <span class="keyword">weak_entry_t</span> *entry;</div><div class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</div><div class="line">        append_referrer(entry, referrer);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// è¯¥å¯¹è±¡ç¬¬ä¸€æ¬¡æ’å…¥</span></div><div class="line">        <span class="keyword">weak_entry_t</span> new_entry(referent, referrer);</div><div class="line">        <span class="comment">// æ˜¯å¦éœ€è¦æ‰©å®¹è¡¨é•¿åº¦</span></div><div class="line">        weak_grow_maybe(weak_table);</div><div class="line">        <span class="comment">// æ’å…¥è¡¨</span></div><div class="line">        weak_entry_insert(weak_table, &amp;new_entry);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Do not set *referrer. objc_storeWeak() requires that the </span></div><div class="line">    <span class="comment">// value not change.</span></div><div class="line"></div><div class="line">    <span class="keyword">return</span> referent_id;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ€»ç»“ä¸€ä¸‹ï¼Œæˆ‘ä»¬weakå¯¹è±¡çš„å¼•ç”¨,ä¸æŒ‡å‘weakå¯¹è±¡çš„å¼•ç”¨ï¼Œä¼ å…¥æ­¤å‡½æ•°ä¸­ï¼Œå‡è®¾æ˜¯é¦–æ¬¡ä¿å­˜æ­¤weakå¯¹è±¡çš„å¼•ç”¨ï¼Œæ„å»ºå‡º<code>weak_entry_t</code>çš„å®ä¾‹<br><code>new_entry</code>,åˆ¤æ–­å½“å‰çš„å¼±å¼•ç”¨è¡¨æ˜¯å¦éœ€è¦å¢åŠ é•¿åº¦ï¼Œç„¶åå°†<code>new_entry</code>æ’å…¥åˆ°å¼±å¼•ç”¨è¡¨<code>weak_table</code>ä¸­ï¼›å¦‚è‹¥ä¸æ˜¯ç¬¬ä¸€æ¬¡ä¿å­˜ï¼Œé¦–å…ˆå–å‡ºæ—§çš„<code>entry</code>ï¼Œå¹¶å°†æŒ‡å‘weakå¯¹è±¡çš„å¼•ç”¨ï¼ˆå³&amp;(person.like)ï¼‰ä¿å­˜åœ¨<code>entry</code>ä¸­ã€‚<br>æ‰€ä»¥å¯ä»¥çœ‹å‡ºï¼Œä¸€ä¸ª<code>entry</code>ä¸­ä¿å­˜äº†æ‰€æœ‰æŒ‡å‘è¯¥weakå¯¹è±¡çš„å¼±å¼•ç”¨</p>
<h2 id="weak-unregister-no-lock-â€¦"><a href="#weak-unregister-no-lock-â€¦" class="headerlink" title="weak_unregister_no_lock(â€¦)"></a>weak_unregister_no_lock(â€¦)</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span></span></div><div class="line"><span class="title">weak_unregister_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id, </span></div><div class="line">                        id *referrer_id)</div><div class="line">&#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line">    objc_object **referrer = (objc_object **)referrer_id;</div><div class="line"></div><div class="line">    <span class="keyword">weak_entry_t</span> *entry;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!referent) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</div><div class="line">        remove_referrer(entry, referrer);</div><div class="line">        <span class="keyword">bool</span> empty = <span class="literal">true</span>;</div><div class="line">        <span class="keyword">if</span> (entry-&gt;out_of_line()  &amp;&amp;  entry-&gt;num_refs != <span class="number">0</span>) &#123;</div><div class="line">            empty = <span class="literal">false</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</div><div class="line">                <span class="keyword">if</span> (entry-&gt;inline_referrers[i]) &#123;</div><div class="line">                    empty = <span class="literal">false</span>; </div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (empty) &#123;</div><div class="line">            weak_entry_remove(weak_table, entry);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Do not set *referrer = nil. objc_storeWeak() requires that the </span></div><div class="line">    <span class="comment">// value not change.</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­è¯¥æ–¹æ³•å°±æ˜¯<code>remove_referrer(entry, referrer);</code>,åœ¨<code>entry</code>ä¸­ç§»é™¤äº†<code>referrer</code>,å¼±å¼•ç”¨è¡¨ä¸­ä¸å†ä¿å­˜æŒ‡å‘è¯¥weakå¯¹è±¡çš„å¼•ç”¨</p>
<h2 id="weakå¯¹è±¡é‡Šæ”¾"><a href="#weakå¯¹è±¡é‡Šæ”¾" class="headerlink" title="weakå¯¹è±¡é‡Šæ”¾"></a>weakå¯¹è±¡é‡Šæ”¾</h2><p><img src="http://omhkfini5.bkt.clouddn.com/weak2.png" alt=""><br>æˆ‘ä»¬å¯ä»¥çœ‹è§å½“ä¸€ä¸ªè¢«å¼±å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡é‡Šæ”¾æ—¶ï¼Œä¼šè°ƒç”¨<code>weak_clear_no_lock(...)</code>æ–¹æ³•</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> </span></div><div class="line"><span class="title">weak_clear_no_lock</span><span class="params">(<span class="keyword">weak_table_t</span> *weak_table, id referent_id)</span> </div><div class="line">&#123;</div><div class="line">    objc_object *referent = (objc_object *)referent_id;</div><div class="line"></div><div class="line">    <span class="keyword">weak_entry_t</span> *entry = weak_entry_for_referent(weak_table, referent);</div><div class="line">    <span class="keyword">if</span> (entry == nil) &#123;</div><div class="line">        <span class="comment">/// XXX shouldn't happen, but does with mismatched CF/objc</span></div><div class="line">        <span class="comment">//printf("XXX no entry for clear deallocating %p\n", referent);</span></div><div class="line">        <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// zero out references</span></div><div class="line">    <span class="keyword">weak_referrer_t</span> *referrers;</div><div class="line">    <span class="keyword">size_t</span> count;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (entry-&gt;out_of_line()) &#123;</div><div class="line">        referrers = entry-&gt;referrers;</div><div class="line">        count = TABLE_SIZE(entry);</div><div class="line">    &#125; </div><div class="line">    <span class="keyword">else</span> &#123;</div><div class="line">        referrers = entry-&gt;inline_referrers;</div><div class="line">        count = WEAK_INLINE_COUNT;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; count; ++i) &#123;</div><div class="line">        objc_object **referrer = referrers[i];</div><div class="line">        <span class="keyword">if</span> (referrer) &#123;</div><div class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;</div><div class="line">               <span class="comment">//weakæŒ‡å‘çš„å¯¹è±¡ï¼Œåœ¨é‡Šæ”¾æ—¶ä¼šè¢«ç½®nilçš„å…³é”®</span></div><div class="line">                *referrer = nil;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</div><div class="line">                _objc_inform(<span class="string">"__weak variable at %p holds %p instead of %p. "</span></div><div class="line">                             <span class="string">"This is probably incorrect use of "</span></div><div class="line">                             <span class="string">"objc_storeWeak() and objc_loadWeak(). "</span></div><div class="line">                             <span class="string">"Break on objc_weak_error to debug.\n"</span>, </div><div class="line">                             referrer, (<span class="keyword">void</span>*)*referrer, (<span class="keyword">void</span>*)referent);</div><div class="line">                objc_weak_error();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    weak_entry_remove(weak_table, entry);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æ–¹æ³•ä¸­ï¼Œé€šè¿‡<code>referent</code>,æ‰¾åˆ°ä¿å­˜æŒ‡å‘è¯¥å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨çš„å®ä¾‹<code>entry</code>ï¼Œé€šè¿‡å¾ªç¯ï¼Œå°†<code>entry</code>ä¸­çš„æ‰€æœ‰å¼•ç”¨ç½®ä¸º<code>nil</code>å³å¯</p>
<h2 id="weakå¼•ç”¨è¡¨å›¾è§£"><a href="#weakå¼•ç”¨è¡¨å›¾è§£" class="headerlink" title="weakå¼•ç”¨è¡¨å›¾è§£"></a>weakå¼•ç”¨è¡¨å›¾è§£</h2><p><img src="http://omhkfini5.bkt.clouddn.com/weak5.png" alt=""></p>
<p>å‚è€ƒèµ„æ–™<br><br><a href="http://www.jianshu.com/p/ef6d9bf8fe59" target="_blank" rel="external">http://www.jianshu.com/p/ef6d9bf8fe59</a><br><br><a href="http://kylinroc.github.io/objc-retain-release.html" target="_blank" rel="external">http://kylinroc.github.io/objc-retain-release.html</a><br><br><a href="http://ios.jobbole.com/89012/" target="_blank" rel="external">http://ios.jobbole.com/89012/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å¼•è¨€&quot;&gt;&lt;a href=&quot;#å¼•è¨€&quot; class=&quot;headerlink&quot; title=&quot;å¼•è¨€&quot;&gt;&lt;/a&gt;å¼•è¨€&lt;/h2&gt;&lt;p&gt;assignä¸weakæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿé¢è¯•çš„æ—¶å€™å¸¸å¸¸ä¼šè¢«é—®åˆ°æ­¤é—®é¢˜ï¼Œæˆ‘ä»¬ä¼šå›ç­”weakä¿®é¥°åœ¨å¯¹è±¡é‡Šæ”¾æ—¶ä¼šè‡ªåŠ¨å˜ä¸ºnil,é‚£ä¹ˆåº•å±‚æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ
    
    </summary>
    
      <category term="iOS" scheme="http://blog.hi996.com/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://blog.hi996.com/tags/iOS/"/>
    
      <category term="Runtime" scheme="http://blog.hi996.com/tags/Runtime/"/>
    
  </entry>
  
  <entry>
    <title>iOSå¤§è§£å¯†ä¹‹Loadæ–¹æ³•</title>
    <link href="http://blog.hi996.com/2017/03/08/iOS-load-methodDes/"/>
    <id>http://blog.hi996.com/2017/03/08/iOS-load-methodDes/</id>
    <published>2017-03-08T09:45:43.000Z</published>
    <updated>2017-03-08T10:09:14.000Z</updated>
    
    <content type="html"><![CDATA[<p>å—ç›Šäºè‹¹æœçš„å°é—­ç”Ÿæ€ï¼Œå¼€å‘è€…å¸¸å¸¸ä¸å¿…å…³æ³¨å¤ªå¤šçš„åº•å±‚ç»†èŠ‚ï¼Œå°±èƒ½åšå‡ºç•Œé¢ç¾è§‚ï¼Œæ€§èƒ½ä¼˜è‰¯çš„Appï¼Œå½“ç„¶å…¶ä¸­Appleä¹Ÿå¤§æ–¹çš„å¼€æ”¾å‡ºäº†å°‘è®¸çš„æºç ï¼Œä¾‹å¦‚Runtimeæºç ,æ„Ÿè°¢<a href="http://blog.csdn.net/wotors/article/details/54426316" target="_blank" rel="external">http://blog.csdn.net/wotors/article/details/54426316</a> æä¾›äº†å¯ä»¥ç¼–è¯‘æˆåŠŸçš„æºç å·¥ç¨‹ã€‚</p>
<h2 id="load"><a href="#load" class="headerlink" title="+load()"></a>+load()</h2><p>æˆ‘ä»¬æ¥é€šè¿‡æºç æ¥æ¢è®¨ä¸€ä¸‹loadæ–¹æ³•çš„åŠ è½½æ—¶æœºï¼Œå’Œåœ¨çˆ¶ç±»ï¼ŒCategoryä¸­çš„åŠ è½½é¡ºåº</p>
<p>é¦–å…ˆæˆ‘ä»¬åœ¨+loadæ–¹æ³•ä¸­æ‰“ä¸Šæ–­ç‚¹ï¼Œçœ‹åˆ°å¦‚ä¸‹çš„æ‰§è¡Œè¿‡ç¨‹</p>
<p><img src="http://omhkfini5.bkt.clouddn.com/load.jpg" alt=""></p>
<p>é€šè¿‡runtimeçš„æºç æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°load_imagesæ–¹æ³•çš„å…·ä½“å®ç°ï¼Œä»£ç å¦‚ä¸‹</p>
<figure class="highlight mm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***********************************************************************</span></div><div class="line">* load_images</div><div class="line">* Process +load in the given images which are being mapped in by dyld.</div><div class="line">*</div><div class="line">* Locking: write-locks runtimeLock and loadMethodLock</div><div class="line">**********************************************************************/</div><div class="line"><span class="keyword">extern</span> <span class="keyword">bool</span> hasLoadMethods(<span class="keyword">const</span> headerType *mhdr);</div><div class="line"><span class="keyword">extern</span> <span class="keyword">void</span> prepare_load_methods(<span class="keyword">const</span> headerType *mhdr);</div><div class="line"></div><div class="line"><span class="keyword">void</span></div><div class="line">load_images(<span class="keyword">const</span> <span class="keyword">char</span> *path __unused, <span class="keyword">const</span> <span class="keyword">struct</span> mach_header *mh)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// Return without taking locks if there are no +load methods here.</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!hasLoadMethods((<span class="keyword">const</span> headerType *)mh)) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    recursive_mutex_locker_t lock(loadMethodLock);</div><div class="line"></div><div class="line">    <span class="comment">// Discover load methods</span></div><div class="line">    &#123;</div><div class="line">        rwlock_writer_t lock2(runtimeLock);</div><div class="line">        prepare_load_methods((<span class="keyword">const</span> headerType *)mh);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Call +load methods (without runtimeLock - re-entrant)</span></div><div class="line">    call_load_methods();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥å‘ç°ä¸¤ä¸ªå…³é”®çš„æ–¹æ³•ï¼Œprepare_load_methods(â€¦) call_load_methods()</p>
<figure class="highlight mm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> prepare_load_methods(<span class="keyword">const</span> headerType *mhdr)</div><div class="line">&#123;</div><div class="line">    size_t count, i;</div><div class="line"></div><div class="line">    runtimeLock.assertWriting();</div><div class="line"></div><div class="line">    classref_t *classlist = </div><div class="line">        _getObjc2NonlazyClassList(mhdr, &amp;count);</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        schedule_class_load(remapClass(classlist[i]));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    category_t **categorylist = _getObjc2NonlazyCategoryList(mhdr, &amp;count);</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">        category_t *cat = categorylist[i];</div><div class="line">        Class cls = remapClass(cat-&gt;cls);</div><div class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>;  <span class="comment">// category for ignored weak-linked class</span></div><div class="line">        realizeClass(cls);</div><div class="line">        assert(cls-&gt;ISA()-&gt;isRealized());</div><div class="line">        add_category_to_loadable_list(cat);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight mm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> schedule_class_load(Class cls)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">if</span> (cls-&gt;info &amp; <span class="built_in">CLS_LOADED</span>) <span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span> (cls-&gt;superclass) schedule_class_load(cls-&gt;superclass);</div><div class="line">    printf(<span class="string">"%s\n\n"</span>,class_getName(cls));</div><div class="line">    add_class_to_loadable_list(cls);</div><div class="line">    cls-&gt;info |= <span class="built_in">CLS_LOADED</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­æˆ‘ä»¬åœ¨void prepare_load_methods(const headerType *mhdr)æ–¹æ³•ä¸­æ˜æ˜¾å¯ä»¥çœ‹å‡ºï¼Œå…ˆå¤„ç†Classçš„ç›¸å…³ä¿¡æ¯ï¼Œåå¤„ç†Categoryçš„ç›¸å…³ä¿¡æ¯ï¼Œåœ¨å¤„ç†Classæ—¶ä¼šè¿›å…¥åˆ°static void schedule_class_load(Class cls)æ–¹æ³•ä¸­,åœ¨æ­¤æ–¹æ³•ä¸­ä¼šé€’å½’çš„å¯»æ‰¾åˆ°çˆ¶ç±»ï¼Œç„¶åè°ƒç”¨å…¶add_class_to_loadable_list(cls)çš„ä¿¡æ¯</p>
<figure class="highlight mm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> add_class_to_loadable_list(Class cls)</div><div class="line">&#123;</div><div class="line">    IMP method;</div><div class="line"></div><div class="line">    loadMethodLock.assertLocked();</div><div class="line"></div><div class="line">    method = cls-&gt;getLoadMethod();</div><div class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;  <span class="comment">// Don't bother if cls has no +load method</span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (PrintLoading) &#123;</div><div class="line">        _objc_inform(<span class="string">"LOAD: class '%s' scheduled for +load"</span>, </div><div class="line">                     cls-&gt;nameForLogging());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (loadable_classes_used == loadable_classes_allocated) &#123;</div><div class="line">        loadable_classes_allocated = loadable_classes_allocated*<span class="number">2</span> + <span class="number">16</span>;</div><div class="line">        loadable_classes = (<span class="keyword">struct</span> loadable_class *)</div><div class="line">            realloc(loadable_classes,</div><div class="line">                              loadable_classes_allocated *</div><div class="line">                              <span class="keyword">sizeof</span>(<span class="keyword">struct</span> loadable_class));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    loadable_classes[loadable_classes_used].cls = cls;</div><div class="line">    loadable_classes[loadable_classes_used].method = method;</div><div class="line">    loadable_classes_used++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨è¿™é‡Œåˆ¤æ–­äº†Classä¸­æ˜¯å¦å®ç°äº†+loadæ–¹æ³•,è‹¥å®ç°äº†æŠŠè¯¥Classé¡ºåºå­˜å‚¨åˆ°loadable_classesä¸­,CategoryåŒç†ä¹Ÿè°ƒç”¨äº†ç›¸å…³æ–¹æ³•ï¼Œå°†å®ç°çš„loadæ–¹æ³•çš„categoryæ·»åŠ åˆ°äº†listä¸­ï¼Œå¦‚ä¸‹å›¾</p>
<figure class="highlight mm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***********************************************************************</span></div><div class="line">* add_category_to_loadable_list</div><div class="line">* Category cat's parent class exists and the category has been attached</div><div class="line">* to its class. Schedule this category for +load after its parent class</div><div class="line">* becomes connected and has its own +load method called.</div><div class="line">**********************************************************************/</div><div class="line"><span class="keyword">void</span> add_category_to_loadable_list(Category cat)</div><div class="line">&#123;</div><div class="line">    IMP method;</div><div class="line"></div><div class="line">    loadMethodLock.assertLocked();</div><div class="line"></div><div class="line">    method = _category_getLoadMethod(cat);</div><div class="line"></div><div class="line">    <span class="comment">// Don't bother if cat has no +load method</span></div><div class="line">    <span class="keyword">if</span> (!method) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (PrintLoading) &#123;</div><div class="line">        _objc_inform(<span class="string">"LOAD: category '%s(%s)' scheduled for +load"</span>, </div><div class="line">                     _category_getClassName(cat), _category_getName(cat));</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">if</span> (loadable_categories_used == loadable_categories_allocated) &#123;</div><div class="line">        loadable_categories_allocated = loadable_categories_allocated*<span class="number">2</span> + <span class="number">16</span>;</div><div class="line">        loadable_categories = (<span class="keyword">struct</span> loadable_category *)</div><div class="line">            realloc(loadable_categories,</div><div class="line">                              loadable_categories_allocated *</div><div class="line">                              <span class="keyword">sizeof</span>(<span class="keyword">struct</span> loadable_category));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    loadable_categories[loadable_categories_used].cat = cat;</div><div class="line">    loadable_categories[loadable_categories_used].method = method;</div><div class="line">    loadable_categories_used++;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œprepare_load_methods(â€¦)è¿™ä¸ªæ–¹æ³•çš„ä½¿å‘½å°±ç®—ç»“æŸäº†ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†å¯ä»¥æ‰§è¡Œloadæ–¹æ³•çš„Classå’ŒCategoryï¼Œæ¥ä¸‹æ¥è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰§è¡Œçš„æ­¥éª¤</p>
<figure class="highlight mm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> call_load_methods(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">bool</span> loading = <span class="literal">NO</span>;</div><div class="line">    <span class="keyword">bool</span> more_categories;</div><div class="line"></div><div class="line">    loadMethodLock.assertLocked();</div><div class="line"></div><div class="line">    <span class="comment">// Re-entrant calls do nothing; the outermost call will finish the job.</span></div><div class="line">    <span class="keyword">if</span> (loading) <span class="keyword">return</span>;</div><div class="line">    loading = <span class="literal">YES</span>;</div><div class="line"></div><div class="line">    <span class="keyword">void</span> *pool = objc_autoreleasePoolPush();</div><div class="line"></div><div class="line">    <span class="keyword">do</span> &#123;</div><div class="line">        <span class="comment">// 1. Repeatedly call class +loads until there aren't any more</span></div><div class="line">        <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>) &#123;</div><div class="line">            call_class_loads();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 2. Call category +loads ONCE</span></div><div class="line">        more_categories = call_category_loads();</div><div class="line"></div><div class="line">        <span class="comment">// 3. Run more +loads if there are classes OR more untried categories</span></div><div class="line">    &#125; <span class="keyword">while</span> (loadable_classes_used &gt; <span class="number">0</span>  ||  more_categories);</div><div class="line"></div><div class="line">    objc_autoreleasePoolPop(pool);</div><div class="line"></div><div class="line">    loading = <span class="literal">NO</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…³é”®æ–¹æ³• call_class_loads() call_category_loads(),å¯ä»¥çœ‹å‡ºæ˜¯å…ˆæ‰§è¡Œçš„Classä¸­çš„loadæ–¹æ³•ï¼Œå†æ‰§è¡ŒCategoryä¸­çš„loadæ–¹æ³•ï¼Œä¸‹é¢æ˜¯ä¸¤ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°</p>
<figure class="highlight mm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/***********************************************************************</span></div><div class="line">* call_class_loads</div><div class="line">* Call all pending class +load methods.</div><div class="line">* If new classes become loadable, +load is NOT called for them.</div><div class="line">*</div><div class="line">* Called only by call_load_methods().</div><div class="line">**********************************************************************/</div><div class="line"><span class="keyword">static</span> <span class="keyword">void</span> call_class_loads(<span class="keyword">void</span>)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    </div><div class="line">    <span class="comment">// Detach current loadable list.</span></div><div class="line">    <span class="keyword">struct</span> loadable_class *classes = loadable_classes;</div><div class="line">    <span class="keyword">int</span> used = loadable_classes_used;</div><div class="line">    loadable_classes = <span class="literal">nil</span>;</div><div class="line">    loadable_classes_allocated = <span class="number">0</span>;</div><div class="line">    loadable_classes_used = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="comment">// Call all +loads for the detached list.</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; used; i++) &#123;</div><div class="line">        Class cls = classes[i].cls;</div><div class="line">        load_method_t load_method = (load_method_t)classes[i].method;</div><div class="line">        <span class="keyword">if</span> (!cls) <span class="keyword">continue</span>; </div><div class="line"></div><div class="line">        <span class="keyword">if</span> (PrintLoading) &#123;</div><div class="line">            _objc_inform(<span class="string">"LOAD: +[%s load]\n"</span>, cls-&gt;nameForLogging());</div><div class="line">        &#125;</div><div class="line">        (*load_method)(cls, SEL_load);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// Destroy the detached list.</span></div><div class="line">    <span class="keyword">if</span> (classes) free(classes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">/***********************************************************************</div><div class="line">* call_category_loads</div><div class="line">* Call some pending category +load methods.</div><div class="line">* The parent class of the +load-implementing categories has all of </div><div class="line">*   its categories attached, in case some are lazily waiting for +initalize.</div><div class="line">* Don&apos;t call +load unless the parent class is connected.</div><div class="line">* If new categories become loadable, +load is NOT called, and they </div><div class="line">*   are added to the end of the loadable list, and we return TRUE.</div><div class="line">* Return FALSE if no new categories became loadable.</div><div class="line">*</div><div class="line">* Called only by call_load_methods().</div><div class="line">**********************************************************************/</div><div class="line">static bool call_category_loads(void)</div><div class="line">&#123;</div><div class="line">    int i, shift;</div><div class="line">    bool new_categories_added = NO;</div><div class="line">    </div><div class="line">    // Detach current loadable list.</div><div class="line">    struct loadable_category *cats = loadable_categories;</div><div class="line">    int used = loadable_categories_used;</div><div class="line">    int allocated = loadable_categories_allocated;</div><div class="line">    loadable_categories = nil;</div><div class="line">    loadable_categories_allocated = 0;</div><div class="line">    loadable_categories_used = 0;</div><div class="line"></div><div class="line">    // Call all +loads for the detached list.</div><div class="line">    for (i = 0; i &lt; used; i++) &#123;</div><div class="line">        Category cat = cats[i].cat;</div><div class="line">        load_method_t load_method = (load_method_t)cats[i].method;</div><div class="line">        Class cls;</div><div class="line">        if (!cat) continue;</div><div class="line"></div><div class="line">        cls = _category_getClass(cat);</div><div class="line">        if (cls  &amp;&amp;  cls-&gt;isLoadable()) &#123;</div><div class="line">            if (PrintLoading) &#123;</div><div class="line">                _objc_inform(&quot;LOAD: +[%s(%s) load]\n&quot;, </div><div class="line">                             cls-&gt;nameForLogging(), </div><div class="line">                             _category_getName(cat));</div><div class="line">            &#125;</div><div class="line">            (*load_method)(cls, SEL_load);</div><div class="line">            cats[i].cat = nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Compact detached list (order-preserving)</div><div class="line">    shift = 0;</div><div class="line">    for (i = 0; i &lt; used; i++) &#123;</div><div class="line">        if (cats[i].cat) &#123;</div><div class="line">            cats[i-shift] = cats[i];</div><div class="line">        &#125; else &#123;</div><div class="line">            shift++;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    used -= shift;</div><div class="line"></div><div class="line">    // Copy any new +load candidates from the new list to the detached list.</div><div class="line">    new_categories_added = (loadable_categories_used &gt; 0);</div><div class="line">    for (i = 0; i &lt; loadable_categories_used; i++) &#123;</div><div class="line">        if (used == allocated) &#123;</div><div class="line">            allocated = allocated*2 + 16;</div><div class="line">            cats = (struct loadable_category *)</div><div class="line">                realloc(cats, allocated *</div><div class="line">                                  sizeof(struct loadable_category));</div><div class="line">        &#125;</div><div class="line">        cats[used++] = loadable_categories[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Destroy the new list.</div><div class="line">    if (loadable_categories) free(loadable_categories);</div><div class="line"></div><div class="line">    // Reattach the (now augmented) detached list. </div><div class="line">    // But if there&apos;s nothing left to load, destroy the list.</div><div class="line">    if (used) &#123;</div><div class="line">        loadable_categories = cats;</div><div class="line">        loadable_categories_used = used;</div><div class="line">        loadable_categories_allocated = allocated;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (cats) free(cats);</div><div class="line">        loadable_categories = nil;</div><div class="line">        loadable_categories_used = 0;</div><div class="line">        loadable_categories_allocated = 0;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (PrintLoading) &#123;</div><div class="line">        if (loadable_categories_used != 0) &#123;</div><div class="line">            _objc_inform(&quot;LOAD: %d categories still waiting for +load\n&quot;,</div><div class="line">                         loadable_categories_used);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return new_categories_added;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>+loadæ–¹æ³•é€šè¿‡å‡½æ•°æŒ‡é’ˆè°ƒç”¨ï¼Œè€Œä¸æ˜¯objc_msgSend<br>+loadæ–¹æ³•çš„è°ƒç”¨æ—¶æœºæ˜¯åœ¨Runtimeåˆå§‹åŒ–çš„æ—¶å€™ï¼Œå…¶ä¸­çš„è°ƒç”¨é¡ºåºæ˜¯çˆ¶ç±»-&gt;å­ç±»-&gt;åˆ†ç±»ï¼Œå…¶ä¸­é»˜è®¤è°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨Classä¸­å’ŒCategoryä¸­éƒ½å®ç°äº†loadæ–¹æ³•ï¼Œåˆ™åœ¨ä¸¤è€…ä¹‹é—´éƒ½ä¼šè°ƒç”¨ï¼Œä¸”åœ¨å­ç±»å®ç°+loadæ–¹æ³•æ—¶ä¸éœ€è¦æ˜¾ç¤ºçš„è°ƒç”¨[super load]</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å—ç›Šäºè‹¹æœçš„å°é—­ç”Ÿæ€ï¼Œå¼€å‘è€…å¸¸å¸¸ä¸å¿…å…³æ³¨å¤ªå¤šçš„åº•å±‚ç»†èŠ‚ï¼Œå°±èƒ½åšå‡ºç•Œé¢ç¾è§‚ï¼Œæ€§èƒ½ä¼˜è‰¯çš„Appï¼Œå½“ç„¶å…¶ä¸­Appleä¹Ÿå¤§æ–¹çš„å¼€æ”¾å‡ºäº†å°‘è®¸çš„æºç ï¼Œä¾‹å¦‚Runtimeæºç ,æ„Ÿè°¢&lt;a href=&quot;http://blog.csdn.net/wotors/article/details/5
    
    </summary>
    
    
      <category term="iOS" scheme="http://blog.hi996.com/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://blog.hi996.com/2016/10/18/hello-world/"/>
    <id>http://blog.hi996.com/2016/10/18/hello-world/</id>
    <published>2016-10-18T03:25:02.000Z</published>
    <updated>2016-10-19T11:12:39.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
    
    </summary>
    
      <category term="Hello World" scheme="http://blog.hi996.com/categories/Hello-World/"/>
    
    
      <category term="Hello World" scheme="http://blog.hi996.com/tags/Hello-World/"/>
    
  </entry>
  
</feed>
